<!DOCTYPE html>
<html lang="en">
<head>
    <title>Listenbrainz Plugin configuration</title>
</head>
<body>
<div
    id="ListenbrainzConfigPage"
    data-role="page"
    class="page type-interior pluginConfigurationPage"
    data-require="emby-input,emby-button,emby-select,emby-checkbox"
>
    <div data-role="content">
        <div class="content-primary">
            <form id="ListenbrainzConfigForm">
                <section id="GlobalConfig">
                    <h2>Global configuration</h2>
                    <div class="grid-layout-3-4">
                        <div class="inputContainer grid-row-3-4_1">
                            <label class="inputLabel inputLabelUnfocused" for="ListenbrainzBaseUrl">ListenBrainz API URL</label>
                            <input id="ListenbrainzBaseUrl" name="ListenbrainzBaseUrl" type="text" is="emby-input"/>
                            <div class="fieldDescription">ListenBrainz API base URL</div>
                        </div>
                        <div class="inputContainer grid-row-3-4_2 grid-row-vertical-center">
                            <div id="ResetListenbrainzBaseUrl" class="raised button block emby-button">Use default</div>
                        </div>
                    </div>
                    <div class="grid-layout-3-4">
                        <div class="inputContainer grid-row-3-4_1">
                            <label class="inputLabel inputLabelUnfocused" for="MusicbrainzBaseUrl">MusicBrainz API URL</label>
                            <input id="MusicbrainzBaseUrl" name="MusicbrainzBaseUrl" type="text" is="emby-input"/>
                            <div class="fieldDescription">MusicBrainz API base URL</div>
                        </div>
                        <div class="inputContainer grid-row-3-4_2 grid-row-vertical-center">
                            <div id="ResetMusicbrainzBaseUrl" class="raised button block emby-button">Use default</div>
                        </div>
                    </div>
                    <div class="checkboxContainer">
                        <label>
                            <input is="emby-checkbox" type="checkbox" id="MusicbrainzEnabled" name="MusicbrainzEnabled"/>
                            <span>Fetch additional metadata from MusicBrainz</span>
                        </label>
                    </div>
                    <div class="checkboxContainer">
                        <div class="inputContainer grid-row-3-4_1">
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="AlternativeListenDetectionEnabled" name="AlternativeListenDetectionEnabled"/>
                                <span>Use alternative mode for recognizing listens</span>
                            </label>
                            <div class="fieldDescription">Use alternative event for recognizing a listen, check <a href="" style="color: gray">plugin documentation</a> for more details</div>
                        </div>
                    </div>
                    <button is="emby-button" type="submit" class="raised button-submit block emby-button" id="saveGlobal">Save (restart plugin to take effect)</button>
                </section>
                <hr class="section-separator"/>
                <section id="UserConfig">
                    <h2>User configuration</h2>
                    <div class="selectContainer">
                        <label class="selectLabel" for="User">User to configure</label>
                        <select is="emby-select" id="User" name="User"></select>
                    </div>
                    <div>
                        <!-- Yes, inline CSS, I know.-->
                        <div style="
                        display: grid;
                        grid-template-columns: 1fr 1fr 1fr 1fr;
                        grid-template-rows: 1fr;
                        gap: 0 15px;
                        grid-auto-flow: row;
                        grid-template-areas: 'tokenInput tokenInput nameValue getName';"
                        >
                            <div class="inputContainer" style="grid-area: tokenInput">
                                <label class="inputLabel inputLabelUnfocused" for="Token">API token</label>
                                <input id="Token" name="Token" type="text" is="emby-input"/>
                                <div class="fieldDescription">ListenBrainz API token.</div>
                            </div>
                            <div class="inputContainer" style="grid-area: nameValue">
                                <label class="inputLabel inputLabelUnfocused" for="UserName">User name</label>
                                <input id="UserName" name="UserName" type="text" is="emby-input" readonly/>
                                <div class="fieldDescription">ListenBrainz user name.</div>
                            </div>
                            <div class="inputContainer" style="grid-area: getName; display:flex; flex-flow: column; justify-content: center">
                                <div id="TokenTestButton"
                                     class="raised button block emby-button"
                                     style="margin: 0">
                                    <span>Get name</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="checkboxContainer">
                        <label>
                            <input
                                is="emby-checkbox"
                                type="checkbox"
                                id="ListenSubmitEnabled"
                                name="ListenSubmitEnabled"
                            />
                            <span>Enable listen submitting</span>
                        </label>
                    </div>
                    <div class="checkboxContainer">
                        <label>
                            <input
                                is="emby-checkbox"
                                type="checkbox"
                                id="SyncFavoritesEnabled"
                                name="SyncFavoritesEnabled"
                            />
                            <span>Enable favorites sync</span>
                        </label>
                    </div>
                </section>
                <div>
                    <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                        <span>Save</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script type="text/css" id="configCss">
        .section-separator {
            margin: 35px 0 25px 0;
        }
        .grid-layout-3-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            grid-template-rows: 1fr;
            gap: 0 15px;
            grid-auto-flow: row;
            grid-template-areas: 'grid-row-3-4_1 grid-row-3-4_1 grid-row-3-4_1 grid-row-3-4_2';
        }
        .grid-row-3-4_1 {
            grid-area: grid-row-3-4_1;
        }
        .grid-row-3-4_2 {
            grid-area: grid-row-3-4_2;
        }
        .grid-row-vertical-center {
            display:flex;
            flex-flow: column;
            justify-content: center;
        }
    </script>
    <script type="text/javascript">
        var ListenbrainzConfig = {
            pluginUniqueId: "59B20823-AAFE-454C-A393-17427F518631",
            globalConfigDefaults: {
              ListenbrainzBaseUrl: "https://api.listenbrainz.org",
              MusicbrainzBaseUrl: "https://musicbrainz.org",
              MusicbrainzEnabled: true,
              AlternativeListenDetectionEnabled: false,
            },
            userConfigDefaults: {
                Token: "",
                MediaBrowserUserId: "",
                Options: {
                    ListenSubmitEnabled: false,
                    SyncFavoritesEnabled: false,
                },
            },

            loadCss: function () {
                let cssValue = document.getElementById("configCss").innerText;
                let styleTag = document.createElement("style");
                styleTag.innerText = cssValue;
                document.getElementsByTagName("head")[0].appendChild(styleTag);
            },

            populateGlobalConfig: function (globalData) {
                document.querySelector("#ListenbrainzBaseUrl")
                    .value = globalData.ListenbrainzBaseUrl

                document.querySelector("#MusicbrainzBaseUrl")
                    .value = globalData.MusicbrainzBaseUrl

                document.querySelector("#MusicbrainzEnabled")
                    .checked = globalData.MusicbrainzEnabled

                document.querySelector("#AlternativeListenDetectionEnabled")
                    .checked = globalData.AlternativeListenDetectionEnabled
            },

            buildUserList: function (users) {
                let html = "";
                users.forEach(function (user) {
                    html += "<option value='" + user.Id + "'>" + user.Name + "</option>";
                })

                document.getElementById("User").innerHTML = html;
            },

            getUserConfig: function (config, userId) {
                if (config.LbUsers == null) {
                    return ListenbrainzConfig.userConfigDefaults;
                }

                let index = config.LbUsers.map(function (user) {
                    return user.MediaBrowserUserId
                }).indexOf(userId);

                if (index === -1) {
                    return ListenbrainzConfig.userConfigDefaults;
                }

                return config.LbUsers[index];
            },

            populateUserConfig: function (userData) {
                if (userData.Token != null) {
                    document.querySelector("#Token")
                        .value = userData.Token
                }

                document.querySelector("#UserName")
                    .value = userData.Name

                document.querySelector("#ListenSubmitEnabled")
                    .checked = userData.Options.ListenSubmitEnabled

                document.querySelector("#SyncFavoritesEnabled")
                    .checked = userData.Options.SyncFavoritesEnabled
            },

            getSelectedUserId: function () {
                return document.querySelector("#User").value;
            },

            gatherInputValues: function () {
                return {
                    GlobalConfig: {
                        ListenbrainzBaseUrl: document.querySelector("#ListenbrainzBaseUrl").value,
                        MusicbrainzBaseUrl: document.querySelector("#MusicbrainzBaseUrl").value,
                        MusicbrainzEnabled: document.querySelector("#MusicbrainzEnabled").checked,
                        AlternativeListenDetectionEnabled: document.querySelector("#AlternativeListenDetectionEnabled").checked,
                    },
                    Token: document.querySelector("#Token").value,
                    Name: document.querySelector("#UserName").value,
                    MediaBrowserUserId: document.querySelector("#User").value,
                    Options: {
                        ListenSubmitEnabled: document.querySelector("#ListenSubmitEnabled").checked,
                        SyncFavoritesEnabled: document.querySelector("#SyncFavoritesEnabled").checked
                    },
                }
            },

            testApiToken: function (token) {
                ApiClient.VerifyListenbrainzToken(token).then(function (data) {
                    console.log(data);

                    let msg = "Unexpected error, check Jellyfin logs.";
                    if (data == null) {
                        Dashboard.alert(msg);
                        console.log(msg);
                        return;
                    }

                    if (data.Valid) {
                        Dashboard.alert(data.Message);
                        document.querySelector("#UserName").value = data.user_name
                        Dashboard.hideLoadingMsg();
                        return;
                    }

                    if (data.Message) {
                        Dashboard.alert(data.Message);
                        console.log(data.Message);
                        Dashboard.hideLoadingMsg();
                        return;
                    }

                    Dashboard.alert(msg);
                    console.log(msg);
                });
            },

            updateGlobalConfig: function (config) {
                let newValues = ListenbrainzConfig.gatherInputValues();
                config.GlobalConfig = newValues.GlobalConfig;
            },

            updateUserConfig: function (config) {
                if (Object.keys(config).length === 0) {
                    config.LbUsers = [];
                }

                let selectedUserId = ListenbrainzConfig.getSelectedUserId();
                let index = config.LbUsers.map(function (user) {
                    return user.MediaBrowserUserId
                }).indexOf(selectedUserId);

                let newData = ListenbrainzConfig.gatherInputValues();
                if (index === -1) {
                    config.LbUsers.push(newData);
                } else {
                    config.LbUsers[index] = newData;
                }
            },
        };

        document.querySelector('#ListenbrainzConfigPage')
            .addEventListener('pageshow', function () {
                ListenbrainzConfig.loadCss();
                Dashboard.showLoadingMsg();

                // load global config
                ApiClient.getPluginConfiguration(ListenbrainzConfig.pluginUniqueId)
                    .then(function (config) {
                        let gConfig = config?.GlobalConfig;
                        if (gConfig?.ListenbrainzBaseUrl == null) {
                            gConfig.ListenbrainzBaseUrl = ListenbrainzConfig.globalConfigDefaults.ListenbrainzBaseUrl;
                        }

                        if (gConfig?.MusicbrainzBaseUrl == null) {
                            gConfig.MusicbrainzBaseUrl = ListenbrainzConfig.globalConfigDefaults.MusicbrainzBaseUrl;
                            gConfig.MusicbrainzEnabled = ListenbrainzConfig.globalConfigDefaults.MusicbrainzEnabled;
                        }

                        if (gConfig?.AlternativeListenDetectionEnabled == null) {
                            gConfig.AlternativeListenDetectionEnabled = ListenbrainzConfig.globalConfigDefaults.AlternativeListenDetectionEnabled;
                        }

                        ListenbrainzConfig.populateGlobalConfig(gConfig);
                    })

                // get users and load user config
                ApiClient.getUsers().then(function (users) {
                    ListenbrainzConfig.buildUserList(users);
                    ApiClient.getPluginConfiguration(ListenbrainzConfig.pluginUniqueId)
                        .then(function (config) {
                            let userConfig = ListenbrainzConfig.getUserConfig(config, users[0].Id);
                            ListenbrainzConfig.populateUserConfig(userConfig);
                            Dashboard.hideLoadingMsg();
                        });
                });
            });

        document.querySelector('#User')
            .addEventListener('change', function () {
                Dashboard.showLoadingMsg();
                let userId = ListenbrainzConfig.getSelectedUserId();
                ApiClient.getPluginConfiguration(ListenbrainzConfig.pluginUniqueId)
                    .then(function (config) {
                        let userConfig = ListenbrainzConfig.getUserConfig(config, userId);
                        ListenbrainzConfig.populateUserConfig(userConfig);
                        Dashboard.hideLoadingMsg();
                    });
            });

        document.querySelector('#TokenTestButton')
            .addEventListener('mouseup', function () {
                Dashboard.showLoadingMsg();

                let formData = ListenbrainzConfig.gatherInputValues();
                if (!formData.Token) {
                    Dashboard.alert("No token set");
                    return;
                } else {
                    ListenbrainzConfig.testApiToken(formData.Token);
                }

                Dashboard.hideLoadingMsg();
            });

        document.querySelector('#ListenbrainzConfigForm')
            .addEventListener('submit', function (e) {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(ListenbrainzConfig.pluginUniqueId)
                    .then(function (config) {
                        try {
                            ListenbrainzConfig.updateGlobalConfig(config);
                            ListenbrainzConfig.updateUserConfig(config);
                        } catch (e) {
                            Dashboard.alert(e);
                            Dashboard.hideLoadingMsg();
                            return;
                        }

                        ApiClient.updatePluginConfiguration(ListenbrainzConfig.pluginUniqueId, config)
                            .then(function (result) {
                                Dashboard.processPluginConfigurationUpdateResult(result);
                            });
                    });

                e.preventDefault();
                return false;
            });

        document.querySelectorAll('#ResetListenbrainzBaseUrl, #ResetMusicbrainzBaseUrl')
            .forEach(btn => {
                btn.addEventListener('click', event => {
                    let inputId = event.target.id.replace('Reset', '');
                    console.log(inputId);
                    document.querySelector('#' + inputId)
                        .value = ListenbrainzConfig.globalConfigDefaults[inputId];
                });
            });

        document.querySelectorAll('#ListenbrainzBaseUrl, #MusicbrainzBaseUrl, #MusicbrainzEnabled')
            .forEach(item => {
                item.addEventListener('change', () => {
                    document.querySelector('#saveGlobal').textContent = 'Save (requires restart to apply)'
                });
            });

        ApiClient.VerifyListenbrainzToken = function (token) {
            if (!token) {
                throw new Error("API token is missing");
            }

            let url = this.getUrl("Listenbrainz/ValidateToken");
            return this.ajax({
                type: "POST",
                url: url,
                data: JSON.stringify(token),
                contentType: "application/json",
                dataType: "json",
            });
        };
    </script>
</div>
</body>
</html>
