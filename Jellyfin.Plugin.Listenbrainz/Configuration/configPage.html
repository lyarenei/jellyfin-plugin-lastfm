<!DOCTYPE html>
<html lang="en">
<head>
    <title>Listenbrainz Plugin configuration</title>
</head>

<body>
<div
    id="ListenbrainzConfigPage"
    data-role="page"
    class="page type-interior pluginConfigurationPage"
    data-require="emby-input,emby-button,emby-select,emby-checkbox"
>
    <div data-role="content">
        <div class="content-primary">
            <form id="ListenbrainzConfigForm">
                <section id="ServerConfig">
                    <h2>Global configuration</h2>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="ListenbrainzApiUrl">Listenbrainz API URL</label>
                        <input id="ListenbrainzApiUrl" name="ListenbrainzUrl" type="text" is="emby-input"/>
                        <div class="fieldDescription">Listenbrainz API URL (leave blank to use default)</div>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="MusicbrainzApiUrl">Musicbrainz API URL</label>
                        <input id="MusicbrainzApiUrl" name="MusicbrainzUrl" type="text" is="emby-input"/>
                        <div class="fieldDescription">Musicbrainz API URL (leave blank to use default)</div>
                    </div>
                    <div class="checkboxContainer">
                        <label>
                            <input is="emby-checkbox" type="checkbox" id="MusicbrainzEnabled" name="MusicbrainzEnabled"/>
                            <span>Fetch additional metadata from Musicbrainz</span>
                        </label>
                    </div>
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save</span>
                        </button>
                    </div>
                </section>
                <hr style="margin: 35px 0 25px 0"/>
                <section id="UserConfig">
                    <h2>User configuration</h2>
                    <div class="selectContainer">
                        <label class="selectLabel" for="User">User to configure</label>
                        <select is="emby-select" id="User" name="User"></select>
                    </div>
                    <div>
                        <!-- Yes, inline CSS, I know.-->
                        <div style="
                        display: grid;
                        grid-template-columns: 1fr 1fr 1fr 1fr;
                        grid-template-rows: 1fr;
                        gap: 0 15px;
                        grid-auto-flow: row;
                        grid-template-areas: 'tokenInput tokenInput nameValue getName';"
                        >
                            <div class="inputContainer" style="grid-area: tokenInput">
                                <label class="inputLabel inputLabelUnfocused" for="Token">API token</label>
                                <input id="Token" name="Token" type="text" is="emby-input"/>
                                <div class="fieldDescription">Listenbrainz API token.</div>
                            </div>
                            <div class="inputContainer" style="grid-area: nameValue">
                                <label class="inputLabel inputLabelUnfocused" for="UserName">User name</label>
                                <input id="UserName" name="UserName" type="text" is="emby-input" readonly/>
                                <div class="fieldDescription">Listenbrainz user name.</div>
                            </div>
                            <div class="inputContainer" style="grid-area: getName; display:flex; flex-flow: column; justify-content: center">
                                <div id="TokenTestButton"
                                     class="raised button block emby-button"
                                     style="margin: 0">
                                    <span>Get name</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="checkboxContainer">
                        <label>
                            <input
                                is="emby-checkbox"
                                type="checkbox"
                                id="ListenSubmitEnabled"
                                name="ListenSubmitEnabled"
                            />
                            <span>Enable listen submitting</span>
                        </label>
                    </div>
                    <div class="checkboxContainer">
                        <label>
                            <input
                                is="emby-checkbox"
                                type="checkbox"
                                id="SyncFavoritesEnabled"
                                name="SyncFavoritesEnabled"
                            />
                            <span>Enable favorites sync</span>
                        </label>
                    </div>
                </section>
                <div>
                    <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                        <span>Save</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="text/javascript">
        var ListenbrainzConfig = {
            pluginUniqueId: "59B20823-AAFE-454C-A393-17427F518631",

            configDefaults: {
                Token: "",
                MediaBrowserUserId: "",
                Options: {
                    ListenSubmitEnabled: false,
                    SyncFavoritesEnabled: false,
                },
            },

            buildUserList: function (users) {
                let html = "";
                users.forEach(function (user) {
                    html += "<option value='" + user.Id + "'>" + user.Name + "</option>";
                })

                document.getElementById("User").innerHTML = html;
            },

            getUserConfig: function (config, userId) {
                if (config.LbUsers == null) {
                    return ListenbrainzConfig.configDefaults;
                }

                let index = config.LbUsers.map(function (user) {
                    return user.MediaBrowserUserId
                }).indexOf(userId);

                if (index === -1) {
                    return ListenbrainzConfig.configDefaults;
                }

                return config.LbUsers[index];
            },

            populateConfig: function (userData) {
                if (userData.Token != null) {
                    document.querySelector("#Token")
                        .value = userData.Token
                }

                document.querySelector("#UserName")
                    .value = userData.Name

                document.querySelector("#ListenSubmitEnabled")
                    .checked = userData.Options.ListenSubmitEnabled

                document.querySelector("#SyncFavoritesEnabled")
                    .checked = userData.Options.SyncFavoritesEnabled
            },

            getSelectedUserId: function () {
                return document.querySelector("#User").value;
            },

            gatherInputValues: function () {
                return {
                    Token: document.querySelector("#Token").value,
                    Name: document.querySelector("#UserName").value,
                    MediaBrowserUserId: document.querySelector("#User").value,
                    Options: {
                        ListenSubmitEnabled: document.querySelector("#ListenSubmitEnabled").checked,
                        SyncFavoritesEnabled: document.querySelector("#SyncFavoritesEnabled").checked
                    },
                }
            },

            testApiToken: function (token) {
                ApiClient.VerifyListenbrainzToken(token).then(function (data) {
                    console.log(data);

                    let msg = "Unexpected error, check Jellyfin logs.";
                    if (data == null) {
                        Dashboard.alert(msg);
                        console.log(msg);
                        return;
                    }

                    if (data.Valid) {
                        Dashboard.alert(data.Message);
                        document.querySelector("#UserName").value = data.user_name
                        Dashboard.hideLoadingMsg();
                        return;
                    }

                    if (data.Message) {
                        Dashboard.alert(data.Message);
                        console.log(data.Message);
                        Dashboard.hideLoadingMsg();
                        return;
                    }

                    Dashboard.alert(msg);
                    console.log(msg);
                });
            }
        };

        document.querySelector('#ListenbrainzConfigPage')
            .addEventListener('pageshow', function () {
                Dashboard.showLoadingMsg();
                ApiClient.getUsers().then(function (users) {
                    ListenbrainzConfig.buildUserList(users);
                    ApiClient.getPluginConfiguration(ListenbrainzConfig.pluginUniqueId)
                        .then(function (config) {
                            let userConfig = ListenbrainzConfig.getUserConfig(config, users[0].Id);
                            ListenbrainzConfig.populateConfig(userConfig);
                            Dashboard.hideLoadingMsg();
                        });
                });
            });

        document.querySelector('#User')
            .addEventListener('change', function () {
                Dashboard.showLoadingMsg();
                let userId = ListenbrainzConfig.getSelectedUserId();
                ApiClient.getPluginConfiguration(ListenbrainzConfig.pluginUniqueId)
                    .then(function (config) {
                        let userConfig = ListenbrainzConfig.getUserConfig(config, userId);
                        ListenbrainzConfig.populateConfig(userConfig);
                        Dashboard.hideLoadingMsg();
                    });
            });

        document.querySelector('#TokenTestButton')
            .addEventListener('mouseup', function () {
                Dashboard.showLoadingMsg();

                let formData = ListenbrainzConfig.gatherInputValues();
                if (!formData.Token) {
                    Dashboard.alert("No token set");
                    return;
                } else {
                    ListenbrainzConfig.testApiToken(formData.Token);
                }

                Dashboard.hideLoadingMsg();
            })

        document.querySelector('#ListenbrainzConfigForm')
            .addEventListener('submit', function (e) {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(ListenbrainzConfig.pluginUniqueId)
                    .then(function (config) {
                        if (Object.keys(config).length === 0) {
                            config.LbUsers = [];
                        }

                        let selectedUserId = ListenbrainzConfig.getSelectedUserId();
                        let index = config.LbUsers.map(function (user) {
                            return user.MediaBrowserUserId
                        }).indexOf(selectedUserId);

                        let newData = ListenbrainzConfig.gatherInputValues();
                        if (!newData.Name) {
                            Dashboard.alert("User name is missing.")
                            Dashboard.hideLoadingMsg();
                            return;
                        }

                        if (index === -1) {
                            config.LbUsers.push(newData);
                        } else {
                            config.LbUsers[index] = newData;
                        }

                        ApiClient.updatePluginConfiguration(ListenbrainzConfig.pluginUniqueId, config)
                            .then(function (result) {
                                Dashboard.processPluginConfigurationUpdateResult(result);
                            });
                    });

                e.preventDefault();
                return false;
            });

        ApiClient.VerifyListenbrainzToken = function (token) {
            if (!token) {
                throw new Error("API token is missing");
            }

            let url = this.getUrl("Listenbrainz/ValidateToken");
            return this.ajax({
                type: "POST",
                url: url,
                data: JSON.stringify(token),
                contentType: "application/json",
                dataType: "json",
            });
        };
    </script>
</div>
</body>
</html>
